% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot.CBFM.R
\name{plot.CBFM}
\alias{plot.CBFM}
\title{Basic plot residual diagnostics from a CBFM fit}
\usage{
\method{plot}{CBFM}(
  x,
  which_plot = 1:5,
  type = "dunnsmyth",
  titles = c("Residuals vs. linear predictors", "Normal probability plot",
    "Residuals vs. unit index", "Residuals vs. species index", "Scale-Location plot"),
  species_colors = NULL,
  smooth = TRUE,
  envelope = TRUE,
  envelope_col = c("blue", "lightblue"),
  envelope_rep = 100,
  which_species = NULL,
  seed = NULL,
  ...
)
}
\arguments{
\item{x}{An object of class "CBFM".}

\item{which_plot}{If a subset of the plots is desired, then a vector containing subset of the integers 1, 2, 3, 4, 5.}

\item{type}{The type of residuals to be used in constructing the plots. Currently the options available are: "response" (default), "pearson", "PIT", "dunnsmyth", and "partial". Can be abbreviated.}

\item{titles}{Titles to appear above each plot.}

\item{species_colors}{Either a scalar is supplied or a vector with length of number of species in the spatio-temporal multivariate abundance data. If the former than all species use this color in the plots. If the latter then the vector specified the colors to use for each species. Defaults to \code{NULL}, which results in each species having a unique color based on the [grDevices::rainbow()] palette.}

\item{smooth}{Should a smoother be added to each plot?}

\item{envelope}{Should approximate simulation envelopes be constructed for the normal probability plot? Default to \code{TRUE}. Note if \code{envelope = FALSE} then \code{envelope_col} and \code{envelope_K} are ignored.}

\item{envelope_col}{A vector of length 2, specifying the colors to use for the lines and shade respectively for the approximate simulation envelopes.}

\item{envelope_rep}{The number of simulations to use in order to build the approximate simulation envelope.}

\item{which_species}{A vector indexing the species to plot, if the residual plots should be constructed for only a subset of species. Defaults to \code{NULL}, in which case all species are plotted. This may be useful if the number of species is quite large.}

\item{seed}{This can be used set the seed when constructing the PIT and Dunn-Smyth residuals, which for discrete responses involve some degree of jittering.}

\item{...}{Additional graphical arguments.}
}
\description{
`r lifecycle::badge("experimental")`

Five potential plots are currently available for some basic residual diagnostics for a fitted \code{CBFM} project: 1) a plot of residuals against
estimated linear predictors; 2) a normal probability or quantile-quantile plot of residuals with simulated point-wise 95\% confidence interval envelope; 3) plot of residuals against observational unit index; 4) a plot of residuals again column index; 5) scale-location plot.
}
\details{
This function is heavily adapted from [gllvm::plot.gllvm()] and [boral::plot.boral()]. A lot of credit goes to the authors of the \code{gllvm} package, especially Jenni Niku, for the code!

As basic residual diagnostics, these plots should behave a follows: 

1. the plot of residuals versus linear predictors should not exhibit any noticeable pattern such as (inverse) fan-shape or a trend; 
2. the normal probability plot should have the residuals lying approximately on a straight line and almost all residuals lying within the (approximate) simulation envelopes; 
3. a plot of residuals against observational unit index should not exhibit any noticeable pattern such as (inverse) fan-shape or a trend. The plot can also be used to look for potential outlying observational units; 
4. a plot of residuals against species index should not exhibit any noticeable pattern such as (inverse) fan-shape or a trend. The plot can also be used to look for potential outlying species; 
5. the scale-location plot should not exhibit any trend. 

If the above does not occur then it may suggest one or more modeling assumptions such as the assumed response distribution, or the model used for the measured covariates, may ot sufficiently satisfied. 

# Warning:
This function only provides basic diagnostic plots. For spatio-temporal data, there are also more specialized methods and plots for assessing the assumptions made in relation to the spatial and/or temporal correlation, and the practitioner is encouraged to examine these. Basic plots may include plotting the residuals as a function of the spatio-temporal coordinates, and constructing autocorrelation plots and covariograms of the residuals; see for example Li (2003), Hyndman and Athanasopoulos (2018), Plant (2018), and Wilke et al. (2019) for some *general* references which contain sections on residual analysis for spatial and time-series data. There are also more (currently) bespoke methods e.g., Bose et al., (2018), although they may be hard to implement and may also not be too useful for the CBFM approach to analyzing spatio-temporal data in general.
}
\examples{
\donttest{
library(autoFRK)
library(FRK)
library(MASS)
library(mvabund)
library(mvtnorm)
library(ROCR)
library(sp)
library(RandomFields)
library(tidyverse)

##------------------------------
## **Example 1: Fitting a CBFM to spatial multivariate presence-absence data** 
## simulated from a spatial latent variable model
## Please note the data generation process (thus) differs from CBFM.
##------------------------------
set.seed(2021)
num_sites <- 500 # 500 (units) sites 
num_spp <- 50 # Number of species
num_X <- 4 # Number of regression slopes

spp_slopes <- matrix(runif(num_spp * num_X, -1, 1), nrow = num_spp)
spp_intercepts <- runif(num_spp, -2, 0)

# Simulate spatial coordinates and environmental covariate components
xy <- data.frame(x = runif(num_sites, 0, 5), y = runif(num_sites, 0, 5))
X <- rmvnorm(num_sites, mean = rep(0,4)) 
colnames(X) <- c("temp", "depth", "chla", "O2")
dat <- data.frame(xy, X)
mm <- model.matrix(~ temp + depth + chla + O2 - 1, data = dat) \%>\% 
scale \%>\% 
as.matrix

# Simulate latent variable component
true_lvs <- RFsimulate(model = RMexp(var=1, scale=2), 
x = xy$x, y = xy$y, n = 2)@data \%>\% 
as.matrix
spp_loadings <- matrix(runif(num_spp * 2, -1, 1), nrow = num_spp) 
set.seed(NULL)

# Simulate spatial multivariate abundance data (presence-absence)
eta <- tcrossprod(cbind(1,mm), cbind(spp_intercepts,spp_slopes)) + 
tcrossprod(true_lvs, spp_loadings)
simy <- matrix(rbinom(num_sites * num_spp, size = 1, 
prob = binomial()$linkinv(eta)), nrow = num_sites)
rm(X, mm, spp_loadings, true_lvs, xy, eta)


# Set up spatial basis functions for CBFM -- Most practitioners will start here! 
num_basisfunctions <- 25 # Number of spatial basis functions to use
basisfunctions <- mrts(dat[,c("x","y")], num_basisfunctions) \%>\% 
as.matrix \%>\%
{.[,-(1)]} # Remove the first intercept column

# Fit CBFM 
useformula <- ~ temp + depth + chla + O2
fitcbfm <- CBFM(y = simy, formula_X = useformula, data = dat, 
B_space = basisfunctions, family = binomial(), control = list(trace = 1))

plot(fitcbfm, ask = TRUE)

plot(fitcbfm, ask = TRUE, pch = ".") # To speed up plotting...
}

}
\references{
Bose, M., Hodges, J. S., and Banerjee, S. (2018). Toward a diagnostic toolkit for linear models with Gaussian‐process distributed random effects. Biometrics, 74, 863-873.

Li, W. K. (2003). Diagnostic checks in time series. CRC Press.

Hyndman, R. J., and Athanasopoulos, G. (2018). Forecasting: principles and practice. OTexts.

Plant, R. E. (2018). Spatial data analysis in ecology and agriculture using R. CRC Press.

Wikle, C. K., Zammit-Mangion, A., and Cressie, N. (2019). Spatio-temporal Statistics with R. Chapman and Hall/CRC
}
\seealso{
[CBFM()] for fitting CBFMs, [fitted.values.CBFM()] for calculating fitted values from a CBFM fit, and [residuals.CBFM()] for calculating various types of residuals.
}
\author{
Francis K.C. Hui <fhui28@gmail.com>, Chris Haak
}
